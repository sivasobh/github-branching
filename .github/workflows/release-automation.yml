name: Release Automation

on:
  push:
    branches:
      - release/**
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
      description:
        description: 'Release description/changelog'
        required: false

env:
  CHANGELOG_FILE: 'CHANGELOG.md'

jobs:
  validate-release-branch:
    name: Validate Release Branch
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Extract Version from Branch
        id: branch_version
        run: |
          BRANCH="${{ github.ref_name }}"
          
          # Extract version from branch name (release/v1.0.0)
          if [[ $BRANCH =~ release/v([0-9]+\.[0-9]+\.[0-9]+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "âœ… Release branch version: v$VERSION"
          else
            echo "âŒ Invalid release branch name format"
            echo "Expected: release/v1.0.0, release/v1.1.0, etc."
            exit 1
          fi
      
      - name: Verify Version Format
        run: |
          VERSION="${{ steps.branch_version.outputs.version }}"
          
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Must be in format: MAJOR.MINOR.PATCH (e.g., 1.0.0)"
            exit 1
          fi
          
          echo "âœ… Version format valid: $VERSION"

  prepare-release:
    name: Prepare Release Notes & Changelog
    runs-on: ubuntu-latest
    
    needs: validate-release-branch
    
    permissions:
      contents: read
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract Version from Branch
        id: version
        run: |
          BRANCH="${{ github.ref_name }}"
          VERSION=$(echo $BRANCH | sed 's/release\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Get Previous Release Tag
        id: previous
        run: |
          # Get all tags sorted by version
          PREVIOUS_TAG=$(git tag -l 'v*.*.*' --sort=-version:refname | head -2 | tail -1 || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG="initial"
          fi
          
          echo "tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "Previous release: $PREVIOUS_TAG"
      
      - name: Generate Changelog Entries
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.previous.outputs.tag }}"
          
          echo "Generating changelog for v$VERSION..."
          
          if [ "$PREVIOUS_TAG" = "initial" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h) by @%an" | head -20)
          else
            COMMITS=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h) by @%an")
          fi
          
          # Categorize commits
          FEATURES=$(echo "$COMMITS" | grep -i "feat" || true)
          FIXES=$(echo "$COMMITS" | grep -i "fix\|bugfix" || true)
          IMPROVEMENTS=$(echo "$COMMITS" | grep -i "improve\|enhance" || true)
          
          CHANGELOG="## Features
          $FEATURES
          
          ## Bug Fixes
          $FIXES
          
          ## Improvements
          $IMPROVEMENTS"
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Format Release Notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          NOTES="# Release v$VERSION
          
          ## What's New
          
          ${{ steps.changelog.outputs.changelog }}
          
          ## Installation
          
          \`\`\`bash
          npm install @myorg/myapp@$VERSION
          # or
          pip install myapp==$VERSION
          # or
          docker pull myorg/myapp:$VERSION
          \`\`\`
          
          ## Documentation
          
          - [Release notes](https://github.com/${{ github.repository }}/releases/tag/v$VERSION)
          - [Documentation](https://docs.example.com)
          - [Upgrade guide](https://docs.example.com/upgrade)
          
          ## Contributors
          
          Thanks to all contributors in this release!
          
          ---
          _Released on $(date '+%Y-%m-%d')_"
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    
    needs: [validate-release-branch, prepare-release]
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Extract Version
        id: version
        run: |
          BRANCH="${{ github.ref_name }}"
          VERSION=$(echo $BRANCH | sed 's/release\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: ${{ needs.prepare-release.outputs.release_notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Merge PR to Main
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = `release: merge release/v${{ steps.version.outputs.version }} to main`;
            const prBody = `## Release Merge
            
            This PR merges the release branch to main for version **v${{ steps.version.outputs.version }}**.
            
            ### Checklist
            - [ ] Version number is correct
            - [ ] CHANGELOG is up to date
            - [ ] Release notes are complete
            - [ ] Tests pass
            - [ ] Documentation is updated
            
            ### After Merge
            - Tag will be created: \`v${{ steps.version.outputs.version }}\`
            - Main branch will point to release
            - Hotfix should be created from main if needed`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              body: prBody,
              head: context.ref,
              base: 'main'
            });
            
            console.log(`Created PR #${pr.data.number}`);
      
      - name: Create Merge PR to Develop
        uses: actions/github-script@v7
        with:
          script: |
            const prTitle = `release: merge release/v${{ steps.version.outputs.version }} to develop`;
            const prBody = `## Release Sync to Develop
            
            This PR syncs the release branch back to develop for version **v${{ steps.version.outputs.version }}**.
            
            ### Purpose
            Ensures develop branch has all release changes (version bumps, CHANGELOG updates, etc.)
            
            ### Checklist
            - [ ] Conflicts resolved
            - [ ] All commits included
            - [ ] Tests pass`;
            
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              body: prBody,
              head: context.ref,
              base: 'develop'
            });
            
            console.log(`Created PR #${pr.data.number}`);

  notify-release:
    name: Notify Team of Release
    runs-on: ubuntu-latest
    
    needs: [validate-release-branch, create-release]
    
    if: success()
    
    steps:
      - name: Extract Version
        id: version
        run: |
          BRANCH="${{ github.ref_name }}"
          VERSION=$(echo $BRANCH | sed 's/release\/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Send Slack Notification
        if: secrets.SLACK_WEBHOOK != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "ðŸš€ New Release: v${{ steps.version.outputs.version }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸŽ‰ Release Published"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Version:*\nv${{ steps.version.outputs.version }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n${{ github.repository }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Status:* âœ… Released to production"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Create Hotfix"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/compare/main...hotfix/v${{ steps.version.outputs.version }}.1"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
